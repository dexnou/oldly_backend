generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int        @id @default(autoincrement()) @db.UnsignedInt
  firstname    String     @db.VarChar(60)
  lastname     String     @db.VarChar(60)
  email        String     @unique @db.VarChar(120)
  whatsapp     String?    @db.VarChar(30)
  passwordHash String?    @map("password_hash") @db.VarChar(255)
  googleId     String?    @unique @map("google_id") @db.VarChar(255)
  avatarUrl    String?    @map("avatar_url") @db.VarChar(255)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  lastLoginAt  DateTime?  @map("last_login_at")
  isActive     Boolean    @default(true) @map("is_active")
  games        Game[]
  rankings     Ranking[]
  userDecks    UserDeck[]

  @@map("users")
}

model Artist {
  id        Int      @id @default(autoincrement()) @db.UnsignedInt
  name      String   @db.VarChar(150)
  country   String?  @db.VarChar(80)
  genre     String?  @db.VarChar(80)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  albums    Album[]
  cards     Card[]

  @@unique([name, country])
  @@index([name])
  @@map("artists")
}

model Album {
  id          Int      @id @default(autoincrement()) @db.UnsignedInt
  artistId    Int      @map("artist_id") @db.UnsignedInt
  title       String   @db.VarChar(150)
  releaseYear Int?     @map("release_year")
  coverUrl    String?  @map("cover_url") @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  artist      Artist   @relation(fields: [artistId], references: [id])
  cards       Card[]

  @@unique([artistId, title, releaseYear])
  @@index([title])
  @@map("albums")
}

model Deck {
  id          Int        @id @default(autoincrement()) @db.UnsignedInt
  title       String     @unique @db.VarChar(100)
  description String?    @db.Text
  theme       String     @db.VarChar(50)
  buyLink     String?    @map("buy_link") @db.VarChar(255)
  coverImage  String?    @map("cover_image") @db.VarChar(255)
  active      Boolean    @default(true)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  cards       Card[]
  games       Game[]
  rankings    Ranking[]
  userDecks   UserDeck[]

  @@index([theme])
  @@map("decks")
}

model Card {
  id                    Int                    @id @default(autoincrement()) @db.UnsignedInt
  deckId                Int                    @map("deck_id") @db.UnsignedInt
  artistId              Int                    @map("artist_id") @db.UnsignedInt
  albumId               Int?                   @map("album_id") @db.UnsignedInt
  songName              String                 @map("song_name") @db.VarChar(150)
  qrCode                String                 @map("qr_code") @db.Text
  qrToken               String                 @unique @map("qr_token") @db.Char(16)
  spotifyUrl            String?                @map("spotify_url") @db.VarChar(255)
  previewUrl            String?                @map("preview_url") @db.VarChar(255)
  difficulty            Difficulty             @default(medium)
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  album                 Album?                 @relation(fields: [albumId], references: [id])
  artist                Artist                 @relation(fields: [artistId], references: [id])
  deck                  Deck                   @relation(fields: [deckId], references: [id])
  gameParticipantRounds GameParticipantRound[]
  gameRounds            GameRound[]

  @@unique([deckId, songName])
  @@index([deckId])
  @@index([artistId])
  @@index([albumId])
  @@index([difficulty])
  @@map("cards")
}

model UserDeck {
  id          Int            @id @default(autoincrement()) @db.UnsignedInt
  userId      Int            @map("user_id") @db.UnsignedInt
  deckId      Int            @map("deck_id") @db.UnsignedInt
  activatedAt DateTime       @default(now()) @map("activated_at")
  source      UserDeckSource @default(purchase)
  deck        Deck           @relation(fields: [deckId], references: [id])
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deckId])
  @@index([deckId], map: "user_decks_deck_id_fkey")
  @@map("user_decks")
}

model Game {
  id           Int               @id @default(autoincrement()) @db.UnsignedInt
  userId       Int               @map("user_id") @db.UnsignedInt
  deckId       Int               @map("deck_id") @db.UnsignedInt
  mode         GameMode          @default(simple)
  status       GameStatus        @default(started)
  totalPoints  Int               @default(0) @map("total_points")
  totalRounds  Int               @default(0) @map("total_rounds")
  startedAt    DateTime          @default(now()) @map("started_at")
  endedAt      DateTime?         @map("ended_at")
  participants GameParticipant[]
  rounds       GameRound[]
  deck         Deck              @relation(fields: [deckId], references: [id])
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deckId])
  @@map("games")
}

model GameParticipant {
  id          Int                    @id @default(autoincrement()) @db.UnsignedInt
  gameId      Int                    @map("game_id") @db.UnsignedInt
  name        String                 @db.VarChar(80)
  totalPoints Int                    @default(0) @map("total_points")
  totalRounds Int                    @default(0) @map("total_rounds")
  createdAt   DateTime               @default(now()) @map("created_at")
  rounds      GameParticipantRound[]
  game        Game                   @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, name])
  @@index([gameId])
  @@map("game_participants")
}

model GameRound {
  id            Int      @id @default(autoincrement()) @db.UnsignedInt
  gameId        Int      @map("game_id") @db.UnsignedInt
  cardId        Int      @map("card_id") @db.UnsignedInt
  songCorrect   Boolean  @default(false) @map("song_correct")
  artistCorrect Boolean  @default(false) @map("artist_correct")
  albumCorrect  Boolean  @default(false) @map("album_correct")
  points        Int      @default(0) @db.TinyInt
  playedAt      DateTime @default(now()) @map("played_at")
  card          Card     @relation(fields: [cardId], references: [id])
  game          Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([gameId, cardId])
  @@index([gameId])
  @@index([cardId], map: "game_rounds_card_id_fkey")
  @@map("game_rounds")
}

model GameParticipantRound {
  id            Int             @id @default(autoincrement()) @db.UnsignedInt
  participantId Int             @map("participant_id") @db.UnsignedInt
  cardId        Int             @map("card_id") @db.UnsignedInt
  songCorrect   Boolean         @default(false) @map("song_correct")
  artistCorrect Boolean         @default(false) @map("artist_correct")
  albumCorrect  Boolean         @default(false) @map("album_correct")
  points        Int             @default(0) @db.TinyInt
  playedAt      DateTime        @default(now()) @map("played_at")
  card          Card            @relation(fields: [cardId], references: [id])
  participant   GameParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([participantId, cardId])
  @@index([participantId])
  @@index([cardId], map: "game_participant_rounds_card_id_fkey")
  @@map("game_participant_rounds")
}

model Ranking {
  id           Int      @id @default(autoincrement()) @db.UnsignedInt
  userId       Int      @map("user_id") @db.UnsignedInt
  deckId       Int      @map("deck_id") @db.UnsignedInt
  pointsTotal  Int      @default(0) @map("points_total")
  gamesPlayed  Int      @default(0) @map("games_played")
  lastPlayedAt DateTime @default(now()) @map("last_played_at")
  level        Int      @default(1)
  deck         Deck     @relation(fields: [deckId], references: [id])
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deckId])
  @@index([deckId, pointsTotal(sort: Desc)])
  @@map("rankings")
}

model AdminUser {
  id           Int       @id @default(autoincrement()) @db.UnsignedInt
  name         String    @db.VarChar(80)
  email        String    @unique @db.VarChar(120)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  role         AdminRole @default(editor)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("admin_users")
}

enum Difficulty {
  easy
  medium
  hard
}

enum UserDeckSource {
  purchase
  gift
  admin
}

enum GameMode {
  simple
  score
}

enum GameStatus {
  started
  finished
  abandoned
}

enum AdminRole {
  super
  editor
}
